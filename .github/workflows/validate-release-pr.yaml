name: Validate Release PR

on:
  pull_request:
    branches: [master]

jobs:
  validate-release:
    if: startsWith(github.head_ref, 'release/automated-')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate release branch base
        run: |
          # Get the merge-base (common ancestor) of this branch and master
          MERGE_BASE=$(git merge-base HEAD origin/master)
          MASTER_HEAD=$(git rev-parse origin/master)

          # Check if this branch was created from current master HEAD
          if [ "$MERGE_BASE" != "$MASTER_HEAD" ]; then
            echo "❌ Release branch was not created from current master HEAD"
            echo "Branch base: $MERGE_BASE"
            echo "Master HEAD: $MASTER_HEAD"
            echo ""
            echo "This release branch is based on outdated master."
            echo "Please close this PR and create a fresh one with 'yarn release'"
            exit 1
          fi

          # Additional check: ensure no merge commits from master
          MERGE_COMMITS=$(git log --merges --grep="Merge.*master" --oneline | wc -l)
          if [ "$MERGE_COMMITS" -gt 0 ]; then
            echo "❌ Release branch contains merge commits from master"
            echo "This invalidates version calculations."
            echo "Please close this PR and create a fresh one with 'yarn release'"
            exit 1
          fi

          echo "✅ Release branch is properly based on current master"
